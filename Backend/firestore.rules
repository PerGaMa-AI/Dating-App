rules_version = '2';
service cloud.firestore {
  match /databases/{db}/documents {

    // configs：不讓客戶端存取（只有雲端函式 Admin SDK 會讀）
    match /configs/{docId} {
      allow read, write: if false;
    }

    // users：只允許本人讀寫自己的文件
    match /users/{uid} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }

    // chats：基本封存 + 訊息寫入
    match /chats/{chatId} {
      // 建立 chat（先放寬，之後可加「需為參與者」限制）
      allow create: if request.auth != null;

      // 更新 chat：鎖住 personaSnapshot（封存，避免“時光倒流”）
      allow update: if request.auth != null
        && request.resource.data.personaSnapshot == resource.data.personaSnapshot;

      // 讀取 chat：登入即可（之後可收緊為參與者限定）
      allow read: if request.auth != null;

      // 訊息子集合
      match /messages/{messageId} {
        // 只能新增「使用者」訊息；AI 回覆由雲端函式寫
        allow create: if request.auth != null
          && request.resource.data.role == "user";
        allow read: if request.auth != null;
        allow update, delete: if false;
      }
    }
  }
}
